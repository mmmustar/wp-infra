---
- name: Déployer WordPress sur Kubernetes avec Helm
  hosts: all
  become: true
  gather_facts: true

  roles:
    - common
    - k3s
    - wordpress

  tasks:
    - name: Vérifier que K3s est installé
      command: kubectl get nodes
      register: k3s_check
      changed_when: false

    - name: Afficher l'état de K3s
      debug:
        msg: "{{ k3s_check.stdout_lines }}"

    - name: Installer Helm
      shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Installer Boto3 et Botocore
      pip:
        name: 
          - boto3
          - botocore
        state: present

    - name: Récupérer les secrets AWS via Boto3
      set_fact:
        aws_secrets: "{{ lookup('amazon.aws.aws_secret', 'book', region='eu-west-3') }}"

    - name: Extraire les variables des secrets
      set_fact:
        wp_db_user: "{{ aws_secrets.MYSQL_USER }}"
        wp_db_password: "{{ aws_secrets.MYSQL_PASSWORD }}"
        wp_db_name: "{{ aws_secrets.MYSQL_DATABASE }}"

    - name: Créer un secret Kubernetes pour WordPress
      shell: |
        kubectl delete secret wordpress-secrets -n default --ignore-not-found
        kubectl create secret generic wordpress-secrets -n default \
          --from-literal=MYSQL_USER={{ wp_db_user }} \
          --from-literal=MYSQL_PASSWORD={{ wp_db_password }} \
          --from-literal=MYSQL_DATABASE={{ wp_db_name }}

    - name: Ajouter le repo Helm Bitnami
      command: helm repo add bitnami https://charts.bitnami.com/bitnami

    - name: Mettre à jour les dépôts Helm
      command: helm repo update

    - name: Déployer WordPress avec Helm
      command: >
        helm upgrade --install wordpress helm/wordpress/ \
        --set wordpress.database.host=wordpress-db.cdaookoquxxr.eu-west-3.rds.amazonaws.com \
        --set wordpress.database.user={{ wp_db_user }} \
        --set wordpress.database.password={{ wp_db_password }} \
        --set wordpress.database.name={{ wp_db_name }}

    - name: Vérifier que WordPress est bien déployé
      command: kubectl get pods -n default
      register: wordpress_pods
      changed_when: false

    - name: Afficher les pods WordPress
      debug:
        msg: "{{ wordpress_pods.stdout_lines }}"
