---
- name: Configuration du serveur WordPress
  hosts: all
  become: true
  gather_facts: true
  vars:
    ansible_python_interpreter: /usr/bin/python3

  pre_tasks:
    - name: Mise à jour du cache apt
      apt:
        update_cache: yes
        cache_valid_time: 3600

  roles:
    - role: common
      tags: [common]

    - role: aws_setup
      tags: [aws]

    # Le rôle nginx est retiré, car nous utilisons le contrôleur Ingress déployé via k3s

    - role: k3s
      tags: [k3s]
      vars:
        k3s_server_args: "--disable traefik --disable servicelb --tls-san {{ domain_name }}"

    - role: wordpress
      tags: [wordpress]

  post_tasks:
    - name: Vérifier que K3s est en cours d'exécution
      service:
        name: k3s
        state: started
        enabled: yes

    - name: Vérifier l'état des pods WordPress
      shell: kubectl get pods -n wordpress
      register: wordpress_pods
      changed_when: false

    - name: Afficher l'état des pods
      debug:
        var: wordpress_pods.stdout_lines
