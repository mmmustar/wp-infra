# roles/k3s/tasks/ebs-csi.yml
---
- name: Fetch AWS Secrets
  command: "aws secretsmanager get-secret-value --secret-id book --region eu-west-3 --output json"
  register: secrets_result
  delegate_to: localhost
  become: false
  changed_when: false

- name: Set variables from secrets
  set_fact:
    aws_account_id: "{{ (secrets_result.stdout | from_json).SecretString | from_json | json_query('aws_account_id') }}"
    aws_ebs_csi_role_name: "{{ (secrets_result.stdout | from_json).SecretString | from_json | json_query('aws_ebs_csi_role_name') }}"

- name: Delete old StorageClass if exists
  command: kubectl delete storageclass ebs-sc
  ignore_errors: true
  when: ebs_csi_enabled

- name: Add Helm repo for EBS CSI Driver
  command: helm repo add aws-ebs-csi-driver https://kubernetes-sigs.github.io/aws-ebs-csi-driver
  become: false
  when: ebs_csi_enabled
  ignore_errors: true

- name: Update Helm repos
  command: helm repo update
  become: false
  when: ebs_csi_enabled
  changed_when: true

- name: Template EBS CSI values
  ansible.builtin.template:
    src: ebs-csi-values.yml.j2
    dest: /tmp/ebs-csi-values.yml
    mode: '0644'
  when: ebs_csi_enabled

- name: Install EBS CSI Driver
  command: >
    helm install aws-ebs-csi-driver aws-ebs-csi-driver/aws-ebs-csi-driver 
    --namespace kube-system 
    --version {{ ebs_csi_version }}
    -f /tmp/ebs-csi-values.yml
  become: false
  when: ebs_csi_enabled
  register: helm_result
  ignore_errors: true
  changed_when: "'already exists' not in helm_result.stderr|default('')"

- name: Upgrade EBS CSI Driver if already installed
  command: >
    helm upgrade aws-ebs-csi-driver aws-ebs-csi-driver/aws-ebs-csi-driver 
    --namespace kube-system 
    --version {{ ebs_csi_version }}
    -f /tmp/ebs-csi-values.yml
  become: false
  when: ebs_csi_enabled and helm_result.rc != 0 and "already exists" in helm_result.stderr|default('')

- name: Clean up temporary values file
  ansible.builtin.file:
    path: /tmp/ebs-csi-values.yml
    state: absent
  when: ebs_csi_enabled